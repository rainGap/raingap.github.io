---
layout: default
title: Catsby 开发手札
---

{{ page.title }}
================
# Catsby 开发手札

《喵之大冒险》(《Catsby》)是一款2D平台动作类游戏。

[TapTap上的链接（已不再提供下载）](https://www.taptap.com/app/71471)  

《Catsby》由四人开发完成，两个策划，两个程序，美术资源是Unity资源商店买的。

后期由于各种原因就剩我一个兼任策划+开发+音效+运营+客服，然后我就开始了一个人折腾一个游戏的愉快之旅。

## 2D框架  

2D Toolkit，简称tk2d，是Unity里的一个2D开发插件，提供了UI、动画、场景的解决方案，基本上满足了大部分2D游戏的开发需求。

在《Catsby》中，场景使用了tk2d的tilemap功能，而角色乃至一切场景物体都是tk2d的sprite。游戏设置两个摄像机，一个用于绘制游戏场景，一个用于绘制UI。

## 角色动画  
tk2d提供了创建图集和动画剪辑的功能，分别名为tk2dSpriteCollection和tk2dSpriteAnimation。

### 创建图集

创建图集的流程很简单，拖动多张图片进去Editor，简单设置一下就生成了相应的材质和 collection data。  
![创建图集的editorg面板](/images/1.PNG)

* 可以设置每个sprite的碰撞区域，除提供普通的矩形碰撞盒外还可以设置多边形的碰撞区域。  
* 可以给sprite加上多个AttachPoint作为挂点，据此实现角色的换装功能。  
* 怪物在攻击动作时的范围也可以通过设置AttachPoint来确定。

### 创建动画

![创建动画剪辑的editor面板](/images/2.PNG)

* 有点类似于Flash的时间轴概念，可以设置哪一帧播放哪个sprite以及clip的帧率。
* 提供了Trigger功能，当动画播放到这个时间点的时候，会抛出这个trigger的消息，trigger可以携带参数。  
* 实际开发中，一个剪辑包含的所有sprite最好都在同一图集里。
* 为了避免在运行时频繁切换剪辑，一般会把逻辑相关性强的动画都放在一个剪辑里，然后通过设置trigger的方式，将一个剪辑分成多个阶段。（大概做法是：在边界帧设置名为stateFlag的trigger，携带一个int参数用以标识这个state，脚本代码里遍历剪辑获取trigger信息，把每一个state的startFrame和endFrame缓存起来。）

## 场景编辑

tk2d有提供在unity scene场景编辑场景地图的功能，为了更灵活地操控地图数据，建议使用外部工具Tiled进行场景编辑导出tmx文件，再在游戏内使用tk2d提供的tilemap功能导入tmx文件进行绘制，如下是Tiled工具的操作界面：  
![Tiled工具操作界面](/images/4.PNG)

具体使用不再详细说明，大概说一下在游戏里是如何设计一个关卡场景。

* 根据游戏需求把场景分为以下几层：
    1、map，固定的障碍图块会刷在这一层，根据事先定好的位置范围又可以分为普通障碍，平台，斜坡等图块类型，在游戏里会有不同的交互表现。
    2、entities，场景Entity会刷在这一层，例如怪物，机关，道具等。有一个对照表，表示大图里的哪个图块对应哪个怪物。
    3、frontdecor，顾名思义，就是装饰层，这一层的图块绘制在场景entity的上层。
    4、decor，同上，只是绘制层次不一样。
    5、bg，背景层。
    6、secret，隐藏区域。玩家一进入这区域就会变透明的层。
    以上可以称之为图块层，因为都是从大图里框选图块来进行绘制的。

* 除此之外，Tiled还提供了对象层，允许开发者在场景里画一个带参数的矩形。  
    例如在配置怪物的时候，在对应entity图块位置上，画一个矩形对象，设置怪物的一些参数属性，例如血量，速度等。配置机关的时候，可以通过对象层关联触发器和机关。
    理论上，可以使用对象层表示一切，但一为了方便压缩tmx，二为了编辑场景的时候能够较为直观地看到场景摆放，还是保留了图块层。
    以下是我之前定义的对象层参数配置方式：  
    ![对象层参数配置参考](/images/5.PNG)

## 角色行为

《喵之大冒险》里的主角喵咪比有着丰富的行为表现，包括冲刺加速，蓄力技能，攀墙，多段跳，下滑，下跳平台，缓慢下落，推箱子，游泳，重力反转，冰面摩擦力变小等。
结合上面的动画和场景，以下大概说一下游戏里的角色行为是如何实现的。  

### 预测下一帧的位置做预判
Unity提供了2D物理系统，但很多时候并不需要如此精确的模拟，在Catsby里我只实现了重力模拟和加减速模拟，已经能够满足表现的需求。主角每一帧的运动状态都与所处位置的周围环境有关，根据当前运动状态预判断下一帧到达的图块，然后检测图块的类型以及对应位置的Entity的tile类型。以下是我定义的TileType：
``` c#
public static class TileType
{
    public  const int START = 1,
        /// <summary>
        /// 可穿透
        /// </summary>
    NOCOLLIDER = 1,
        /// <summary>
        /// 障碍
        /// </summary>
    OBSTACLE = 2,
        /// <summary>
        /// 左斜坡-小
        /// </summary>
    LEFT_SLOP_1 = 3,
        /// <summary>
        /// 左斜坡
        /// </summary>
    LEFT_SLOP_2 = 4,
        /// <summary>
        /// 右斜坡-小
        /// </summary>
    RIGHT_SLOP_1 = 5,
        /// <summary>
        /// 右斜坡
        /// </summary>
    RIGHT_SLOP_2 = 6,
        /// <summary>
        /// 平台（上下跳都可穿透）
        /// </summary>
    PLATFORM = 7,
        /// <summary>
        /// 可移动障碍
        /// </summary>
    OBSTACLE_DYNAMIC = 8,
        /// <summary>
        /// 水域
        /// </summary>
    WATER = 9,
        /// <summary>
        /// 可移动平台
        /// </summary>
    PLATFORM_DYNAMIC = 10,
    END = 10;
}
```
其中OBSTACLE_DYNAMIC和PLATFORM_DYNAMIC是设置在Entity上的。
根据主角周围图块的tiletype，会有不同的操作表现。例如主角在斜坡上会沿着斜坡往下滑；下方是平台则可以下+跳穿越平台；在移动平台上，玩家会相对平台移动；处于水域则重力减少；如果左边是障碍墙块，玩家按住左键则可以攀墙等。
基于这些行为，关卡设计也有了足够的发挥空间。


## 以下是截的各种动图

* 各种能力表现  
![各种能力](/images/10.gif)

* 部分机关  
![部分机关](/images/11.gif)  
![部分机关](/images/12.gif)  
![部分机关](/images/13.gif)  
![部分机关](/images/14.gif)  
![部分机关](/images/22.gif)  

* 部分boss  
![boss1](/images/15.gif)  
![boos2](/images/21.gif)  

## 玩法体验上可以优化的

1、地形的图块分为地面，地基，凹转角，凸转角，这部分完全可以程序化自动匹配，编辑地图时只需刷一种图块，表示是某一种style的地形，程序根据图块相对位置自动刷相应的图块。

2、无缝切换场景（这里不是指Unity的scene），现在的做法是切换地图的时候会有一段LoadTMX的过渡，代入感并不好，可以考虑下无缝加载TMX，最终实现Dead Cell那样的大场景，也方便做地图的排列组合。

3、目前是支持角色的连招的，也支持受击动作和打击动作，但由于资源问题这部分是简化处理了，其实加入一些连招和打断，还有空挡躲闪，应该打击感会好很多。

